# Suggested Kafka Deployment

This document will explain how Kiln should be deployed in an AWS environment, using Amazon's Managed Streaming for Kafka (MSK) service to simplify the deployment of a Kafka cluster. It's possible to use Kiln with a self-administered Kafka + Zookeeper cluster, but that's beyond the scope of this documentation.

![Kiln network diagram](images/AWS%20Diagram%20for%20Kiln%20MSK.png)

In order to provide clear segmentation between your Kiln deploiyment and other services that might be running in your AWS account, it is suggested that Kiln is deployed in a separate VPC. Because Kafka should be deployed with a minimum of 3 brokers, this VPC should ideally contain 3 private subnets across 3 Availability Zones, to minimise the chance of two brokers being unavailable at any time. These Kafka brokers should have a security group applied to them that allows all incoming and outgoing traffic on all ports to other members of the security group to allow broker -> broker communications. They should also have a rule in this security group allowing incoming traffic on TCP port 9092 from members of a second security group that will be applied to clients.

The Kiln VPC should also contain 3 public subnets, which is where the Kiln Data Collector and any Kiln Service Connectors will be deployed. The Kiln Data Collector and any Kiln Service Connectors will need to have the previously mentioned Kafka Client security group applied to them, so that they can communicate with the Kafka Cluster. The Kiln Data Collector should have access restricted to only systems you expect to be sending data to Kiln (your CI servers and engineer's workstations for example). Any Kiln Service Connectors will need outbound internet connectivity to connect to Slack, Trello, etc.

When building an environment configuration for the Kiln Data Collector, you will need to provide the subnet IDs of the 3 public subnets you have created as well as the IDs of the Kafka Client security group and any additional security groups you need to allow expected incoming traffic. The format for this configuration file can be found in the [Data Collector component documentation](data-collector/README.md).
